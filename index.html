<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>JP Tracker ‚Äî –ø—Ä–æ—Å—Ç–æ–π –≤–µ–±-—Ç—Ä–µ–∫–µ—Ä –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ —è–ø–æ–Ω—Å–∫–æ–≥–æ</title>
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 128 128'%3E%3Crect width='128' height='128' rx='24' fill='%230b0f14'/%3E%3Cpath d='M16 96h96' stroke='%235cc8ff' stroke-width='8'/%3E%3Ctext x='50%' y='56%' dominant-baseline='middle' text-anchor='middle' font-family='Arial, Helvetica, sans-serif' font-weight='700' font-size='52' fill='%23e6edf3'%3EJP%3C/text%3E%3C/svg%3E"/>
  <style>
    :root{ --bg:#0b0f14; --panel:#111822; --muted:#1a2330; --text:#e6edf3; --sub:#9fb2c7; --brand:#5cc8ff; --ok:#53d17a; --warn:#ffd166; --bad:#ff6b6b; --line:#233042; }
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(180deg,#0b0f14 0%, #0d131b 100%);color:var(--text);font:14px/1.45 system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial, sans-serif}
    .wrap{max-width:1100px;margin:0 auto;padding:24px}
    h1{font-size:28px;margin:0 0 12px;letter-spacing:.2px}
    h2{font-size:18px;margin:18px 0 8px;color:var(--brand)}
    h3{font-size:15px;margin:14px 0 8px;color:var(--sub);text-transform:uppercase;letter-spacing:.08em}
    .topbar{display:flex;gap:10px;align-items:center;justify-content:space-between;margin:6px 0 20px}
    .muted{color:var(--sub)}
    .grid{display:grid;gap:12px}
    .g-2{grid-template-columns:1fr 1fr}
    .g-3{grid-template-columns:repeat(3,1fr)}
    .g-4{grid-template-columns:repeat(4,1fr)}
    @media (max-width:900px){.g-3,.g-4{grid-template-columns:1fr 1fr}.g-2{grid-template-columns:1fr}}
    @media (max-width:640px){.g-3,.g-4{grid-template-columns:1fr}}
    .card{background:linear-gradient(180deg,rgba(255,255,255,0.04),rgba(255,255,255,0.02));border:1px solid var(--line);border-radius:16px;padding:14px 16px;box-shadow:0 6px 18px rgba(0,0,0,.25);transition:transform .15s ease, box-shadow .15s ease;margin-bottom:12px}
    .card:hover{transform:translateY(-2px);box-shadow:0 10px 24px rgba(0,0,0,.35)}
    .kpi{display:flex;flex-direction:column;gap:6px}
    .kpi .label{color:var(--sub);font-size:12px}
    .kpi .value{font-size:22px;font-weight:700}
    .btn{appearance:none;border:1px solid var(--line);background:linear-gradient(180deg,#15202c,#0e1621);color:var(--text);padding:9px 12px;border-radius:12px;cursor:pointer}
    .btn:hover{filter:brightness(1.1)}
    .btn.brand{border-color:rgba(92,200,255,.5);background:linear-gradient(180deg,#1a3344,#11202c)}
    .btn.danger{border-color:rgba(255,107,107,.4);background:linear-gradient(180deg,#3a1014,#24090b)}
    .btn.small{padding:6px 10px;font-size:12px;border-radius:10px}
    .buttons{display:flex;gap:8px;flex-wrap:wrap}
    input, select, textarea{width:100%;background:#0e1621;border:1px solid var(--line);border-radius:10px;color:var(--text);padding:8px 10px}
    input[type="number"]{text-align:right}
    label{display:block;font-size:12px;color:var(--sub);margin:8px 0 6px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media (max-width:700px){.row{grid-template-columns:1fr}}
    table{width:100%;border-collapse:collapse}
    th, td{border-bottom:1px solid var(--line);padding:8px 6px;text-align:left}
    th{color:var(--sub);font-weight:600;font-size:12px;text-transform:uppercase;letter-spacing:.05em}
    tr:hover td{background:rgba(92,200,255,0.06)}
    .progress{height:10px;background:#0f1925;border-radius:999px;position:relative;border:1px solid var(--line)}
    .progress > span{position:absolute;inset:0;transform-origin:left;transform:scaleX(var(--p,0));background:linear-gradient(90deg,#5cc8ff,#53d17a);border-radius:999px;transition:transform .6s cubic-bezier(.2,.6,.2,1)}
    .pill{display:inline-flex;align-items:center;gap:6px;background:rgba(92,200,255,.12);border:1px solid rgba(92,200,255,.35);color:#cfeeff;padding:4px 8px;border-radius:999px;font-size:12px}
    .note{font-size:12px;color:var(--sub)}
    .right{justify-self:end}
    .link{color:#8bd4ff;text-decoration:none}
    .link:hover{text-decoration:underline}
    .footer{margin:24px 0 8px;color:var(--sub);font-size:12px}
    .chart{display:block;width:100%;background:#0e1621;border:1px solid var(--line);border-radius:12px}
    .chart-title{font-size:12px;color:var(--sub);margin:6px 0 0}
    .controls{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
<div class="wrap">
  <div class="topbar">
    <div>
      <h1>Japanese Progress Tracker ‚Äî Web</h1>
      <div class="muted">–ì–µ–π–º–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —É—á—ë—Ç –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –¥–ª—è —è–ø–æ–Ω—Å–∫–æ–≥–æ (–ª–æ–∫–∞–ª—å–Ω–æ –≤ –±—Ä–∞—É–∑–µ—Ä–µ + –æ–±–ª–∞—á–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è)</div>
    </div>
    <div class="buttons">
      <button class="btn small" id="btn-export">–≠–∫—Å–ø–æ—Ä—Ç JSON</button>
      <label for="file-import" class="btn small" style="display:inline-flex;align-items:center;gap:8px;cursor:pointer">–ò–º–ø–æ—Ä—Ç JSON<input id="file-import" type="file" accept="application/json" style="display:none"></label>
      <button class="btn small danger" id="btn-reset">–°–±—Ä–æ—Å–∏—Ç—å</button>
      <button class="btn small" id="btn-autosave-toggle" title="–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å JSON –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏">–ê–≤—Ç–æ—ç–∫—Å–ø–æ—Ä—Ç: –≤—ã–∫–ª</button>
      <button class="btn small" id="btn-autosave-pick" title="–í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª –¥–ª—è –∞–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è (–µ—Å–ª–∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è)">–§–∞–π–ª‚Ä¶</button>
      <button class="btn small" id="btn-sync" title="–ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è">–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å</button>
      <div class="pill" id="autosave-ind">–ê–≤—Ç–æ—ç–∫—Å–ø–æ—Ä—Ç: –≤—ã–∫–ª</div>
    </div>
  </div>

  <section class="card" id="auth-card" style="margin-bottom:24px">
    <h2>–í—Ö–æ–¥ –∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è</h2>
    <div class="buttons">
      <input type="text" placeholder="email" id="auth-email" style="max-width:180px">
      <input type="password" placeholder="–ø–∞—Ä–æ–ª—å" id="auth-pass" style="max-width:180px">
      <button class="btn small" id="btn-register">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
      <button class="btn small" id="btn-login">–í–æ–π—Ç–∏</button>
      <button class="btn small danger" id="btn-logout" style="display:none">–í—ã–π—Ç–∏</button>
      <div class="pill" id="auth-user" style="display:none"></div>
    </div>
    <div class="note">–ï—Å–ª–∏ –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω Supabase ‚Äî –≤—Å—ë —Ä–∞–±–æ—Ç–∞–µ—Ç –ª–æ–∫–∞–ª—å–Ω–æ. –ü–æ—Å–ª–µ –≤—Ö–æ–¥–∞ –¥–∞–Ω–Ω—ã–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É—é—Ç—Å—è –º–µ–∂–¥—É —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞–º–∏.</div>
  </section>

  <section class="grid g-4" id="dashboard"></section>

  <section class="card" id="charts" style="margin-top:12px">
    <h2>–ì—Ä–∞—Ñ–∏–∫–∏: XP –∏ –º–∏–Ω—É—Ç—ã</h2>
    <div class="controls" style="margin-bottom:6px">
      <label>–î–∏–∞–ø–∞–∑–æ–Ω:
        <select id="range-select">
          <option value="7">7 –¥–Ω–µ–π</option>
          <option value="30" selected>30 –¥–Ω–µ–π</option>
          <option value="90">90 –¥–Ω–µ–π</option>
        </select>
      </label>
    </div>
    <div class="grid g-2">
      <div>
        <canvas id="chart-xp" class="chart" height="260"></canvas>
        <div class="chart-title">XP –ø–æ –¥–Ω—è–º</div>
      </div>
      <div>
        <canvas id="chart-mins" class="chart" height="260"></canvas>
        <div class="chart-title">–ú–∏–Ω—É—Ç—ã –ø–æ –¥–Ω—è–º</div>
      </div>
    </div>
  </section>

  <section class="card" style="margin-top:12px">
    <h2>–ï–∂–µ–¥–Ω–µ–≤–Ω–∞—è –∑–∞–ø–∏—Å—å</h2>
    <div class="row">
      <div>
        <label>–î–∞—Ç–∞</label>
        <input type="date" id="f-date" />
      </div>
      <div>
        <label>–ú–∏–Ω—É—Ç—ã —É—á–µ–±—ã (–≤—Å–µ–≥–æ)</label>
        <input type="number" id="f-mins" min="0" step="1" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä, 45" />
      </div>
    </div>

    <div class="row">
      <div>
        <label>Anki ‚Äî —Ä–µ–≤—å—é (—à—Ç)</label>
        <input type="number" id="f-anki-rev" min="0" step="1" />
      </div>
      <div>
        <label>Anki ‚Äî –Ω–æ–≤—ã–µ (—à—Ç)</label>
        <input type="number" id="f-anki-new" min="0" step="1" />
      </div>
    </div>

    <div class="row">
      <div>
        <label>Listening (–º–∏–Ω)</label>
        <input type="number" id="f-listen" min="0" step="1" />
      </div>
      <div>
        <label>Shadowing (–º–∏–Ω)</label>
        <input type="number" id="f-shadow" min="0" step="1" />
      </div>
    </div>

    <div class="row">
      <div>
        <label>Speaking / Output (–º–∏–Ω)</label>
        <input type="number" id="f-speak" min="0" step="1" />
      </div>
      <div>
        <label>Grammar reps (—à—Ç)</label>
        <input type="number" id="f-gram" min="0" step="1" />
      </div>
    </div>

    <div class="row">
      <div>
        <label>–ú–∞–Ω–≥–∞ ‚Äî —Å—Ç—Ä–∞–Ω–∏—Ü—ã</label>
        <input type="number" id="f-manga" min="0" step="1" />
      </div>
      <div>
        <label>–°—Ç—Ä–∏–º ‚Äî –º–∏–Ω—É—Ç—ã</label>
        <input type="number" id="f-stream" min="0" step="1" />
      </div>
    </div>

    <div class="row">
      <div>
        <label>–ù–æ–≤—ã–µ —Å–ª–æ–≤–∞ (—à—Ç)</label>
        <input type="number" id="f-words" min="0" step="1" />
      </div>
      <div>
        <label>–ö–ª–∏–ø—ã —Ä–∞—Å—à–∏—Ñ—Ä. (—à—Ç, –ø–æ 1 –º–∏–Ω)</label>
        <input type="number" id="f-clips" min="0" step="1" />
      </div>
    </div>

    <div class="row">
      <div>
        <label>–†–∞–∑–≥–æ–≤–æ—Ä—ã 30 –º–∏–Ω (—à—Ç)</label>
        <input type="number" id="f-convo" min="0" step="1" />
      </div>
      <div>
        <label>–ë–æ—Å—Å-—Ñ–∞–π—Ç—ã (—à—Ç)</label>
        <input type="number" id="f-boss" min="0" step="1" />
      </div>
    </div>

    <div class="row">
      <div>
        <label>2k ‚Äî –≤—ã—É—á–µ–Ω–æ –≤—Å–µ–≥–æ</label>
        <input type="number" id="f-2k" min="0" step="1" />
      </div>
      <div>
        <label>6k ‚Äî –≤—ã—É—á–µ–Ω–æ –≤—Å–µ–≥–æ</label>
        <input type="number" id="f-6k" min="0" step="1" />
      </div>
    </div>

    <div class="row">
      <div>
        <label>–ö–∞—Å—Ç–æ–º-1 (—à—Ç)</label>
        <input type="number" id="f-custom1" min="0" step="1" />
      </div>
      <div>
        <label>–ö–∞—Å—Ç–æ–º-2 (—à—Ç)</label>
        <input type="number" id="f-custom2" min="0" step="1" />
      </div>
    </div>

    <label>–ù–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ / –∑–∞–º–µ—Ç–∫–∏</label>
    <textarea id="f-notes" rows="2" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä, great focus / busy day"></textarea>

    <div class="buttons" style="margin-top:10px">
      <button class="btn brand" id="btn-save-day">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –¥–µ–Ω—å</button>
      <button class="btn" id="btn-clear-form">–û—á–∏—Å—Ç–∏—Ç—å —Ñ–æ—Ä–º—É</button>
      <div class="pill" id="xp-preview">XP –∑–∞ –¥–µ–Ω—å: 0</div>
    </div>
  </section>

  <section class="card" style="margin-top:12px">
    <h2>–ñ—É—Ä–Ω–∞–ª –¥–Ω–µ–π</h2>
    <div class="note">–ö–ª–∏–∫ –ø–æ —Å—Ç—Ä–æ–∫–µ ‚Äî –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–µ–Ω—å –≤ —Ñ–æ—Ä–º—É. –£–¥–∞–ª–µ–Ω–∏–µ ‚Äî –∫–æ—Ä–∑–∏–Ω–∞ —Å–ø—Ä–∞–≤–∞.</div>
    <div style="overflow:auto; max-height:380px; margin-top:8px">
      <table id="tbl-days"></table>
    </div>
  </section>

  <section class="grid g-2" style="margin-top:12px">
    <div class="card">
      <h2>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ XP</h2>
      <div class="note">–ú–æ–∂–Ω–æ –º–µ–Ω—è—Ç—å –∑–Ω–∞—á–µ–Ω–∏—è XP –∏ –Ω–∞–∑–≤–∞–Ω–∏—è –∫–∞—Å—Ç–æ–º–Ω—ã—Ö –∑–∞–¥–∞—á. –°–∞–º–∏ —Ä–∞—Å—á—ë—Ç—ã –ø—Ä–∏–≤—è–∑–∞–Ω—ã –∫ –ø–æ–ª—è–º —Ñ–æ—Ä–º—ã (—Å–º. –ø–æ–¥—Å–∫–∞–∑–∫–∏ –Ω–∏–∂–µ).</div>
      <table id="tbl-xp" style="margin-top:8px"></table>
      <div class="note" style="margin-top:8px">–§–æ—Ä–º—É–ª—ã: —Ä–µ–≤—å—é/–Ω–æ–≤—ã–µ/–º–∏–Ω—É—Ç—ã/—Å—Ç—Ä–∞–Ω–∏—Ü—ã –ø–µ—Ä–µ–≤–æ–¥—è—Ç—Å—è –≤ ¬´–ø–æ—Ä—Ü–∏–∏¬ª: 10 —Ä–µ–≤—å—é, 10 –Ω–æ–≤—ã—Ö, 20 –º–∏–Ω —Å–ª—É—à–∞–Ω–∏—è, 10 –º–∏–Ω —à–∞–¥–æ—É–∏–Ω–≥–∞, 15 –º–∏–Ω –≥–æ–≤–æ—Ä–µ–Ω–∏—è, 1 –≥—Ä–∞–º–º‚Äë—Ä–µ–ø, 5 —Å—Ç—Ä. –º–∞–Ω–≥–∏, 1 –∫–ª–∏–ø (1 –º–∏–Ω), 1 —Ä–∞–∑–≥–æ–≤–æ—Ä (30 –º–∏–Ω), 1 –±–æ—Å—Å-—Ñ–∞–π—Ç, –∫–∞—Å—Ç–æ–º‚Äë1 (—à—Ç), –∫–∞—Å—Ç–æ–º‚Äë2 (—à—Ç).</div>
    </div>

    <div class="card">
      <h2>–£—Ä–æ–≤–Ω–∏ –∏ —Ü–µ–ª–∏</h2>
      <table id="tbl-levels" style="margin-top:8px"></table>
      <h3>–ú–∞–π–ª—Å—Ç–æ–Ω—ã</h3>
      <table id="tbl-milestones"></table>
      <div class="buttons" style="margin-top:8px">
        <button class="btn small" id="btn-add-milestone">–î–æ–±–∞–≤–∏—Ç—å –º–∞–π–ª—Å—Ç–æ–Ω</button>
      </div>
    </div>
  </section>

  <div class="footer">–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏–¥—ë—Ç –≤ <b>localStorage</b> –∏ –≤ <b>Supabase</b> (–µ—Å–ª–∏ –≤–æ—à–ª–∏). –î–µ–ª–∞–π —ç–∫—Å–ø–æ—Ä—Ç JSON –∫–∞–∫ –±—ç–∫–∞–ø.</div>
</div>

<script>
// –ì–ª–æ–±–∞–ª—å–Ω–∞—è –ª–æ–≤—É—à–∫–∞ –æ—à–∏–±–æ–∫, —á—Ç–æ–±—ã –Ω–µ –ª–æ–º–∞–ª—Å—è –≤–µ—Å—å UI –∏ –±—ã–ª–æ –≤–∏–¥–Ω–æ –æ—à–∏–±–∫—É
window.addEventListener('error', (e)=>{
  console.error('Global error:', e.error||e.message);
});

window.addEventListener('DOMContentLoaded', function(){
(function(){
  const $ = (sel, root=document) => root.querySelector(sel);
  const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));
  const LS_KEY = 'jp_tracker_state_v1';

  const defaults = {
    meta: { localUpdatedAt: null },
    entries: {}, // keyed by ISO date
    xp: {
      anki10rev: {name:'Anki 10 —Ä–µ–≤—å—é', xp:10},
      anki10new: {name:'Anki 10 –Ω–æ–≤—ã—Ö', xp:20},
      listen20:  {name:'Listening 20 –º–∏–Ω', xp:20},
      shadow10:  {name:'Shadowing 10 –º–∏–Ω', xp:15},
      speak15:   {name:'Speaking 15 –º–∏–Ω', xp:25},
      gram1:     {name:'Grammar SRS 1', xp:20},
      manga5:    {name:'–ú–∞–Ω–≥–∞ 5 —Å—Ç—Ä–∞–Ω–∏—Ü', xp:25},
      clip1:     {name:'–ö–ª–∏–ø+—Ç—Ä–∞–Ω—Å–∫—Ä. 1 –º–∏–Ω', xp:20},
      convo30:   {name:'–†–∞–∑–≥–æ–≤–æ—Ä 30 –º–∏–Ω', xp:50},
      boss:      {name:'–ë–æ—Å—Å-—Ñ–∞–π—Ç', xp:200},
      custom1:   {name:'–ö–∞—Å—Ç–æ–º‚Äë1', xp:30},
      custom2:   {name:'–ö–∞—Å—Ç–æ–º‚Äë2', xp:15},
    },
    levels: [
      {level:1, need:0}, {level:2, need:300}, {level:3, need:700}, {level:4, need:1200},
      {level:5, need:1800}, {level:6, need:2500}, {level:7, need:3300}, {level:8, need:4200},
      {level:9, need:5200}, {level:10, need:6300}
    ],
    milestones: [
      {when:'–ö–æ–Ω–µ—Ü 1 –º–µ—Å—è—Ü–∞', goal:'–ü–∏—Ç—á-–∞–∫—Ü–µ–Ω—Ç + 400 —Å–ª–æ–≤ (2k) + 5 —Å—Ç—Ä. –º–∞–Ω–≥–∏', done:false},
      {when:'–ö–æ–Ω–µ—Ü 3 –º–µ—Å—è—Ü–∞', goal:'N4‚Äë—è–¥—Ä–æ + 1000 —Å–ª–æ–≤ (2k) + 10 –º–∏–Ω JP‚Äë—Å—Ç—Ä–∏–º', done:false},
      {when:'–ö–æ–Ω–µ—Ü 6 –º–µ—Å—è—Ü–∞', goal:'N4 –º–æ–∫ –ø—Ä–æ–π–¥–µ–Ω; 2000 —Å–ª–æ–≤ (2k); 1 —Ç–æ–º –º–∞–Ω–≥–∏', done:false},
      {when:'–ö–æ–Ω–µ—Ü 9 –º–µ—Å—è—Ü–∞', goal:'N3 50%; 3500 —Å–ª–æ–≤; 30‚Äë–º–∏–Ω JP‚Äë—Å—Ç—Ä–∏–º', done:false},
      {when:'–ö–æ–Ω–µ—Ü 12 –º–µ—Å—è—Ü–∞', goal:'N3 –æ–∫–æ–ª–æ; 5000 —Å–ª–æ–≤; 2 —Ç–æ–º–∞ –º–∞–Ω–≥–∏', done:false},
    ]
  };

  let state = load() || defaults;

  function save(){
    state.meta = state.meta || {}; state.meta.localUpdatedAt = new Date().toISOString();
    localStorage.setItem(LS_KEY, JSON.stringify(state));
  }
  function load(){ try { return JSON.parse(localStorage.getItem(LS_KEY)); } catch(e){ return null; } }

  function todayISO(){ const d=new Date(); d.setHours(0,0,0,0); return d.toISOString().slice(0,10); }
  function toISO(val){ const d = new Date(val); if(isNaN(+d)) return todayISO(); d.setHours(0,0,0,0); return d.toISOString().slice(0,10); }
  function human(dateISO){ const d=new Date(dateISO); return d.toLocaleDateString('ru-RU', {day:'2-digit', month:'2-digit', year:'numeric'}); }

  function computeXP(entry){
    const X = state.xp;
    const parts = [
      Math.floor((+entry.ankiRev||0)/10) * X.anki10rev.xp,
      Math.floor((+entry.ankiNew||0)/10) * X.anki10new.xp,
      Math.floor((+entry.listen||0)/20) * X.listen20.xp,
      Math.floor((+entry.shadow||0)/10) * X.shadow10.xp,
      Math.floor((+entry.speak||0)/15) * X.speak15.xp,
      Math.floor((+entry.gram||0)/1)  * X.gram1.xp,
      Math.floor((+entry.manga||0)/5) * X.manga5.xp,
      Math.floor((+entry.clips||0)/1)* X.clip1.xp,
      Math.floor((+entry.convo||0)/1)* X.convo30.xp,
      Math.floor((+entry.boss||0)/1) * X.boss.xp,
      Math.floor((+entry.custom1||0)/1) * X.custom1.xp,
      Math.floor((+entry.custom2||0)/1) * X.custom2.xp,
    ];
    return parts.reduce((a,b)=>a+b,0);
  }

  function levelFromXP(total){
    const arr = state.levels.slice().sort((a,b)=>a.need-b.need);
    let lvl = arr[0];
    for(const it of arr){ if(total >= it.need) lvl = it; }
    const next = arr.find(it=>it.need>lvl.need) || null;
    const into = total - lvl.need;
    const toNext = next ? (next.need - total) : 0;
    const pct = next ? Math.max(0, Math.min(1, into / (next.need - lvl.need))) : 1;
    return {level:lvl.level, next: next? next.level : lvl.level, pct, into, toNext, currNeed:lvl.need, nextNeed: next? next.need : lvl.need};
  }

  function entriesSorted(){ return Object.entries(state.entries).sort((a,b)=>a[0]<b[0]?1:-1).map(([k,v])=>({date:k, ...v})); }

  function stats(){
    const arr = entriesSorted();
    const last7 = arr.filter((_,i)=> i < 7);
    const totalXP = arr.reduce((s,e)=> s + (e.xp||0), 0);
    const totalXP7 = last7.reduce((s,e)=> s + (e.xp||0), 0);
    const avgMins7 = last7.length ? (last7.reduce((s,e)=> s + (+e.mins||0), 0) / last7.length) : 0;
    const latest2k = arr.length ? (arr[0].k2 || 0) : 0;
    const latest6k = arr.length ? (arr[0].k6 || 0) : 0;
    const st = streak();
    const lvl = levelFromXP(totalXP);
    return {totalXP, totalXP7, avgMins7, latest2k, latest6k, streakDays: st, level: lvl};
  }

  function streak(){
    let count = 0; const today = new Date(); today.setHours(0,0,0,0);
    for(let i=0;i<3650;i++){
      const d = new Date(today); d.setDate(today.getDate()-i);
      const iso = d.toISOString().slice(0,10);
      const e = state.entries[iso];
      if(!e || !(+e.mins>0)) break; else count++;
    }
    return count;
  }

  function setDateDefault(){ $('#f-date').value = todayISO(); }

  function readForm(){
    const date = toISO($('#f-date').value || todayISO());
    const entry = {
      mins: +($('#f-mins').value||0),
      ankiRev: +($('#f-anki-rev').value||0),
      ankiNew: +($('#f-anki-new').value||0),
      listen: +($('#f-listen').value||0),
      shadow: +($('#f-shadow').value||0),
      speak: +($('#f-speak').value||0),
      gram: +($('#f-gram').value||0),
      manga: +($('#f-manga').value||0),
      stream: +($('#f-stream').value||0),
      words: +($('#f-words').value||0),
      clips: +($('#f-clips').value||0),
      convo: +($('#f-convo').value||0),
      boss: +($('#f-boss').value||0),
      k2: +($('#f-2k').value||0),
      k6: +($('#f-6k').value||0),
      custom1: +($('#f-custom1').value||0),
      custom2: +($('#f-custom2').value||0),
      notes: $('#f-notes').value||''
    };
    entry.xp = computeXP(entry);
    return {date, entry};
  }

  function fillForm(dateISO){
    const e = state.entries[dateISO]; if(!e) return;
    $('#f-date').value = dateISO;
    $('#f-mins').value = e.mins||0;
    $('#f-anki-rev').value = e.ankiRev||0;
    $('#f-anki-new').value = e.ankiNew||0;
    $('#f-listen').value = e.listen||0;
    $('#f-shadow').value = e.shadow||0;
    $('#f-speak').value = e.speak||0;
    $('#f-gram').value = e.gram||0;
    $('#f-manga').value = e.manga||0;
    $('#f-stream').value = e.stream||0;
    $('#f-words').value = e.words||0;
    $('#f-clips').value = e.clips||0;
    $('#f-convo').value = e.convo||0;
    $('#f-boss').value = e.boss||0;
    $('#f-2k').value = e.k2||0;
    $('#f-6k').value = e.k6||0;
    $('#f-custom1').value = e.custom1||0;
    $('#f-custom2').value = e.custom2||0;
    $('#f-notes').value = e.notes||'';
    updateXpPreview();
  }

  function clearForm(){ $$('#f-mins, #f-anki-rev, #f-anki-new, #f-listen, #f-shadow, #f-speak, #f-gram, #f-manga, #f-stream, #f-words, #f-clips, #f-convo, #f-boss, #f-2k, #f-6k, #f-custom1, #f-custom2').forEach(i=>i.value=''); $('#f-notes').value=''; setDateDefault(); updateXpPreview(); }

  function renderDashboard(){
    const d = stats();
    const lvl = d.level;
    $('#dashboard').innerHTML = `
      <div class="card kpi"><div class="label">–£—Ä–æ–≤–µ–Ω—å</div>
        <div class="value">${lvl.level} <span class="muted">‚Üí next ${lvl.next}</span></div>
        <div class="progress" style="--p:${lvl.pct}"><span></span></div>
        <div class="note">–î–æ —Å–ª–µ–¥. —É—Ä–æ–≤–Ω—è: ${lvl.toNext} XP</div>
      </div>
      <div class="card kpi"><div class="label">XP –∑–∞ 7 –¥–Ω–µ–π</div>
        <div class="value">${d.totalXP7}</div>
        <div class="note">–í—Å–µ–≥–æ XP: ${d.totalXP}</div>
      </div>
      <div class="card kpi"><div class="label">–°—Ä–µ–¥. –º–∏–Ω/–¥–µ–Ω—å (7–¥)</div>
        <div class="value">${d.avgMins7.toFixed(1)}</div>
        <div class="note">–°—Ç—Ä–∏–∫: ${d.streakDays} –¥–Ω–µ–π</div>
      </div>
      <div class="card kpi"><div class="label">Deck 2k / 6k</div>
        <div class="value">${d.latest2k} / ${d.latest6k}</div>
        <div class="progress" style="--p:${Math.min(1, (d.latest2k||0)/2000)}"><span></span></div>
        <div class="note">–ü—Ä–æ–≥—Ä–µ—Å—Å –∫ 2k: ${(Math.min(100, ((d.latest2k||0)/2000)*100)).toFixed(0)}%</div>
      </div>`;
  }

  function renderDays(){
    const arr = entriesSorted();
    const head = `<tr><th>–î–∞—Ç–∞</th><th class="right">XP</th><th class="right">–ú–∏–Ω</th><th class="right">2k</th><th class="right">6k</th><th>–ó–∞–º–µ—Ç–∫–∏</th><th></th></tr>`;
    const rows = arr.map(e=>{
      return `<tr data-date="${e.date}"><td>${human(e.date)}</td><td class="right">${e.xp||0}</td><td class="right">${e.mins||0}</td><td class="right">${e.k2||0}</td><td class="right">${e.k6||0}</td><td>${(e.notes||'').replace(/</g,'&lt;')}</td><td class="right"><button class="btn small danger act-del" data-date="${e.date}">üóë</button></td></tr>`
    }).join('');
    $('#tbl-days').innerHTML = head + rows;

    $$('#tbl-days tr[data-date]').forEach(tr=>{
      tr.addEventListener('click', (ev)=>{
        if(ev.target && ev.target.classList.contains('act-del')) return;
        const iso = tr.getAttribute('data-date');
        fillForm(iso);
        window.scrollTo({top:0, behavior:'smooth'});
      });
    });

    $$('#tbl-days .act-del').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const iso = btn.getAttribute('data-date');
        if(confirm('–£–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å—å –∑–∞ ' + human(iso) + '?')){
          delete state.entries[iso]; save(); renderAll(); setDateDefault(); clearForm(); syncToDb();
        }
      });
    });
  }

  function renderXP(){
    const x = state.xp;
    const head = `<tr><th>–ó–∞–¥–∞—á–∞</th><th class="right">XP</th></tr>`;
    const ids = ['anki10rev','anki10new','listen20','shadow10','speak15','gram1','manga5','clip1','convo30','boss','custom1','custom2'];
    const rows = ids.map(id=>{
      return `<tr><td><input data-xid="${id}" data-field="name" value="${x[id].name}"></td><td class="right"><input type="number" min="0" step="1" data-xid="${id}" data-field="xp" value="${x[id].xp}" style="max-width:120px"></td></tr>`
    }).join('');
    $('#tbl-xp').innerHTML = head + rows;

    $$('#tbl-xp input').forEach(inp=>{
      inp.addEventListener('change', ()=>{
        const id = inp.getAttribute('data-xid');
        const field = inp.getAttribute('data-field');
        if(field==='xp') state.xp[id].xp = +inp.value||0; else state.xp[id].name = inp.value||'';
        save(); updateXpPreview(); renderDashboard(); syncToDb();
      });
    });
  }

  function renderLevels(){
    const head = `<tr><th>–£—Ä–æ–≤–µ–Ω—å</th><th class="right">–ù—É–∂–Ω–æ XP (–Ω–∞–∫–æ–ø.)</th><th></th></tr>`;
    const rows = state.levels
      .sort((a,b)=>a.need-b.need)
      .map((lv,i)=>`<tr>
        <td><input data-lid="${i}" data-field="level" type="number" value="${lv.level}" style="max-width:80px"></td>
        <td class="right"><input data-lid="${i}" data-field="need" type="number" min="0" step="50" value="${lv.need}" style="max-width:140px"></td>
        <td class="right"><button class="btn small danger" data-del-level="${i}">–£–¥–∞–ª–∏—Ç—å</button></td>
      </tr>`).join('');
    $('#tbl-levels').innerHTML = head + rows + `<tr><td colspan="3" class="right"><button class="btn small" id="btn-add-level">–î–æ–±–∞–≤–∏—Ç—å —É—Ä–æ–≤–µ–Ω—å</button></td></tr>`;

    $('#btn-add-level').onclick = ()=>{ state.levels.push({level:(state.levels.length?state.levels[state.levels.length-1].level+1:1), need:(state.levels.length?state.levels[state.levels.length-1].need+800:0)}); save(); renderLevels(); renderDashboard(); syncToDb(); };
    $$('#tbl-levels [data-del-level]').forEach(b=> b.onclick = ()=>{ const i=+b.getAttribute('data-del-level'); state.levels.splice(i,1); save(); renderLevels(); renderDashboard(); syncToDb(); });
    $$('#tbl-levels input').forEach(inp=> inp.onchange = ()=>{ const i=+inp.getAttribute('data-lid'); const f=inp.getAttribute('data-field'); state.levels[i][f] = +inp.value||0; save(); renderLevels(); renderDashboard(); syncToDb(); });
  }

  function renderMilestones(){
    const head = `<tr><th>–ö–æ–≥–¥–∞</th><th>–¶–µ–ª—å</th><th>–ì–æ—Ç–æ–≤–æ</th><th></th></tr>`;
    const rows = state.milestones.map((m,i)=>`<tr>
      <td><input data-mid="${i}" data-field="when" value="${m.when}"></td>
      <td><input data-mid="${i}" data-field="goal" value="${m.goal}"></td>
      <td><input type="checkbox" data-mid="${i}" data-field="done" ${m.done?'checked':''}></td>
      <td class="right"><button class="btn small danger" data-del-m="${i}">–£–¥–∞–ª–∏—Ç—å</button></td>
    </tr>`).join('');
    $('#tbl-milestones').innerHTML = head + rows;

    $$('#tbl-milestones input').forEach(inp=>{
      inp.onchange = ()=>{ const i=+inp.getAttribute('data-mid'); const f=inp.getAttribute('data-field'); state.milestones[i][f] = (f==='done') ? inp.checked : inp.value; save(); syncToDb(); };
    });
    $$('#tbl-milestones [data-del-m]').forEach(btn=> btn.onclick = ()=>{ const i=+btn.getAttribute('data-del-m'); state.milestones.splice(i,1); save(); renderMilestones(); syncToDb(); });
    $('#btn-add-milestone').onclick = ()=>{ state.milestones.push({when:'–ö–æ–≥–¥–∞', goal:'–ù–æ–≤–∞—è —Ü–µ–ª—å', done:false}); save(); renderMilestones(); syncToDb(); };
  }

  function updateXpPreview(){
    const {entry} = readForm();
    $('#xp-preview').textContent = 'XP –∑–∞ –¥–µ–Ω—å: ' + entry.xp;
  }

  function renderAll(){ renderDashboard(); renderCharts(); renderDays(); renderXP(); renderLevels(); renderMilestones(); updateXpPreview(); }

  function exportJSON(){
    const blob = new Blob([JSON.stringify(state, null, 2)], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = 'jp_tracker_export.json'; a.click();
    setTimeout(()=> URL.revokeObjectURL(url), 1000);
  }

  function importJSON(file){
    const reader = new FileReader();
    reader.onload = () => {
      try{ const data = JSON.parse(reader.result); if(data && data.entries){ state = Object.assign({}, defaults, data); save(); renderAll(); syncToDb(); alert('–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ —É—Å–ø–µ—à–Ω–æ'); } else { alert('–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞'); } }
      catch(e){ alert('–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞: ' + e.message); }
    };
    reader.readAsText(file);
  }

  // === Supabase: –ª–æ–≥–∏–Ω –∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è ===
  const SUPABASE_URL = 'https://zagkdaytskkmcecvdlze.supabase.co';
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InphZ2tkYXl0c2trbWNlY3ZkbHplIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYyMjY1MTMsImV4cCI6MjA3MTgwMjUxM30.3Uh26b35OEXAJ950Tk-qIbtyssSbcw4xGquNBFE40u0';
  let sb = null, currentUser = null;

  function show(el, disp='inline-flex'){ if(el) el.style.display = disp; }
  function hide(el){ if(el) el.style.display = 'none'; }

  function supaInit(){
    if (!SUPABASE_URL || !SUPABASE_ANON_KEY || !window.supabase) {
      console.warn('Supabase –Ω–µ —Å–∫–æ–Ω—Ñ–∏–≥—É—Ä–∏—Ä–æ–≤–∞–Ω ‚Äî —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –ª–æ–∫–∞–ª—å–Ω–æ.');
      return;
    }
    sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    sb.auth.onAuthStateChange(async (_event, session) => {
      currentUser = session?.user || null;
      updateAuthUI();
      if (currentUser) { await syncFromDb(); }
    });
  }

  function updateAuthUI(){
    const st   = document.getElementById('auth-user');
    const e    = document.getElementById('auth-email');
    const p    = document.getElementById('auth-pass');
    const btnR = document.getElementById('btn-register');
    const btnL = document.getElementById('btn-login');
    const btnO = document.getElementById('btn-logout');

    if (!sb){
      if (st){ st.textContent='Supabase –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω'; show(st); }
      show(e, 'inline-block'); show(p, 'inline-block');
      show(btnR); show(btnL); hide(btnO);
      return;
    }

    if (currentUser){
      if (st){ st.textContent = currentUser.email || '–í–æ—à—ë–ª'; show(st); }
      hide(e); hide(p); hide(btnR); hide(btnL); show(btnO);
    } else {
      if (st){ st.textContent = '–ù–µ –≤–æ—à–ª–∏'; show(st); }
      show(e, 'inline-block'); show(p, 'inline-block');
      show(btnR); show(btnL); hide(btnO);
    }
  }

  async function authSignup(){
    if(!sb) { updateAuthUI(); return alert('Supabase –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω'); }
    const email = (document.getElementById('auth-email')?.value||'').trim();
    const password = (document.getElementById('auth-pass')?.value||'').trim();
    const {error} = await sb.auth.signUp({ email, password });
    alert(error ? ('–û—à–∏–±–∫–∞: '+error.message) : '–ü—Ä–æ–≤–µ—Ä—å –ø–æ—á—Ç—É –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è (–µ—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω–æ)');
  }

  async function authLogin(){
    if(!sb) { updateAuthUI(); return alert('Supabase –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω'); }
    const email = (document.getElementById('auth-email')?.value||'').trim();
    const password = (document.getElementById('auth-pass')?.value||'').trim();
    const {error} = await sb.auth.signInWithPassword({ email, password });
    if (error) alert('–û—à–∏–±–∫–∞: '+error.message);
  }

  async function authLogout(){
    // –ù–∞–¥—ë–∂–Ω—ã–π –ª–æ–≥–∞—É—Ç –¥–∞–∂–µ –Ω–∞ —Å—Ç–∞—Ç–∏—á–µ—Å–∫–æ–º —Ö–æ—Å—Ç–∏–Ω–≥–µ / –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö —Å–µ—Ç–∏
    function clearSupabaseStorage(){
      try{
        const ref = (new URL(SUPABASE_URL)).host.split('.')[0]; // zagkdaytskkmcecvdlze
        for(let i=0;i<localStorage.length;i++){
          const k = localStorage.key(i);
          if(!k) continue;
          if(k.startsWith('sb-') && (k.includes(ref) || k.includes('auth-token') || k.includes('persist-session'))){
            try{ localStorage.removeItem(k); }catch(_e){}
          }
        }
        // —Ç–∞–∫–∂–µ —á–∏—Å—Ç–∏–º –≤–æ–∑–º–æ–∂–Ω—ã–π –∫—ç—à —Å–µ—Å—Å–∏–∏ –≤ –ø–∞–º—è—Ç–∏ supabase-js
        if(sb && sb.auth) try{ sb.auth.signOut(); }catch(_e){}
      }catch(_e){}
    }

    try{
      if(sb && sb.auth){
        // –ü—ã—Ç–∞–µ–º—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –≤—ã–π—Ç–∏ —á–µ—Ä–µ–∑ SDK
        try{ await sb.auth.signOut({ scope: 'global' }); }
        catch(e1){
          console.warn('signOut(global) failed -> local fallback', e1?.message||e1);
          try{ await sb.auth.signOut({ scope: 'local' }); }catch(e2){ console.warn('signOut(local) failed', e2?.message||e2); }
        }
      }
    } finally {
      clearSupabaseStorage();
      currentUser = null;
      updateAuthUI();
      // –ñ—ë—Å—Ç–∫–æ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏–º —Å—Ç—Ä–∞–Ω–∏—Ü—É, —á—Ç–æ–±—ã –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ —Å–±—Ä–æ—Å–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ SDK
      try{ location.reload(); }catch(_e){}
    }
  }

  function deepClone(o){ return JSON.parse(JSON.stringify(o)); }

  function mergeStates(local, remote, remoteUpdatedAt){
    if(!local) return remote || defaults;
    if(!remote) return local;
    const l = deepClone(local), r = deepClone(remote);
    const lt = new Date(l.meta?.localUpdatedAt||0).getTime()||0;
    const rt = new Date(r.meta?.localUpdatedAt||remoteUpdatedAt||0).getTime()||0;

    const newer = rt > lt ? r : l;
    const older = rt > lt ? l : r;

    const merged = deepClone(newer);
    merged.entries = Object.assign({}, older.entries||{}, newer.entries||{});
    merged.xp = newer.xp || older.xp || defaults.xp;
    merged.levels = newer.levels || older.levels || defaults.levels;
    merged.milestones = newer.milestones || older.milestones || defaults.milestones;
    merged.meta = { localUpdatedAt: new Date(Math.max(lt, rt)).toISOString() };
    return merged;
  }

  async function syncFromDb(){
    if(!sb || !currentUser) return;
    try{
      const {data, error} = await sb.from('states').select('data, updated_at').eq('user_id', currentUser.id).single();
      if (error && error.code !== 'PGRST116') throw error; // 116 = row not found
      if (data && data.data){
        state = mergeStates(state, data.data, data.updated_at);
        save(); renderAll();
      } else {
        await sb.from('states').upsert({ user_id: currentUser.id, data: state });
      }
    } catch(e){ console.error('syncFromDb error', e); }
  }

  async function syncToDb(){
    if (!sb || !currentUser) return;
    try{ await sb.from('states').upsert({ user_id: currentUser.id, data: state }); }
    catch(e){ console.error('syncToDb error', e); }
  }

  // --- Autosave (file or download fallback) ---
  function downloadText(filename, text){
    const blob = new Blob([text], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = filename; a.click();
    setTimeout(()=> URL.revokeObjectURL(url), 1000);
  }
  let settings = null;
  let fileHandle = null;
  const SETTINGS_KEY = 'jp_tracker_settings_v1';

  function saveSettings(){ try{ localStorage.setItem(SETTINGS_KEY, JSON.stringify(settings)); }catch(e){} }
  function loadSettings(){
    try{ return JSON.parse(localStorage.getItem(SETTINGS_KEY)) || {autosaveEnabled:false, autosaveMode: (('showSaveFilePicker' in window)?'handle':'download'), filename:''}; }
    catch(e){ return {autosaveEnabled:false, autosaveMode: 'download', filename:''}; }
  }
  function updateAutosaveUI(){
    const ind = document.getElementById('autosave-ind');
    const modeText = !settings?.autosaveEnabled ? '–≤—ã–∫–ª' : (settings.autosaveMode==='handle' && settings.filename ? ('–≤ —Ñ–∞–π–ª: '+settings.filename) : '–≤ –ó–∞–≥—Ä—É–∑–∫–∏');
    if(ind) ind.textContent = '–ê–≤—Ç–æ—ç–∫—Å–ø–æ—Ä—Ç: ' + modeText;
    const btnPick = document.getElementById('btn-autosave-pick');
    if(btnPick) btnPick.style.display = (settings?.autosaveEnabled && ('showSaveFilePicker' in window)) ? 'inline-flex' : 'none';
    const btnToggle = document.getElementById('btn-autosave-toggle');
    if(btnToggle) btnToggle.textContent = '–ê–≤—Ç–æ—ç–∫—Å–ø–æ—Ä—Ç: ' + (settings?.autosaveEnabled ? '–≤–∫–ª' : '–≤—ã–∫–ª');
  }
  async function chooseAutosaveFile(){
    if(!('showSaveFilePicker' in window)){
      alert('–ë—Ä–∞—É–∑–µ—Ä –Ω–µ –¥–∞—ë—Ç –ø—Ä—è–º—É—é –∑–∞–ø–∏—Å—å –≤ —Ñ–∞–π–ª. –ë—É–¥–µ—Ç –∞–≤—Ç–æ—ç–∫—Å–ø–æ—Ä—Ç –≤ –ó–∞–≥—Ä—É–∑–∫–∏.');
      settings.autosaveEnabled = true; settings.autosaveMode='download'; settings.filename=''; saveSettings(); updateAutosaveUI(); return;
    }
    try{
      const handle = await window.showSaveFilePicker({
        suggestedName:'jp_tracker.json',
        types:[{description:'JSON', accept:{'application/json':['.json']}}]
      });
      const perm = await handle.requestPermission({writable:true});
      if(perm !== 'granted'){ alert('–†–∞–∑—Ä–µ—à–µ–Ω–∏–µ –Ω–∞ –∑–∞–ø–∏—Å—å –Ω–µ –≤—ã–¥–∞–Ω–æ. –ò—Å–ø–æ–ª—å–∑—É—é –∞–≤—Ç–æ—ç–∫—Å–ø–æ—Ä—Ç –≤ –ó–∞–≥—Ä—É–∑–∫–∏.'); settings.autosaveMode='download'; settings.filename=''; saveSettings(); updateAutosaveUI(); return; }
      fileHandle = handle; settings.autosaveEnabled = true; settings.autosaveMode='handle'; settings.filename = handle.name; saveSettings(); updateAutosaveUI();
    }catch(e){ /* –æ—Ç–º–µ–Ω–∞ –≤—ã–±–æ—Ä–∞ */ }
  }
  function fallbackDownload(data){
    const ts = new Date().toISOString().replace(/[:]/g,'-').replace('T','_').slice(0,16);
    downloadText('jp_tracker_autosave_'+ts+'.json', data);
  }
  async function autoSaveNow(){
    if(!settings || !settings.autosaveEnabled) return;
    const data = JSON.stringify(state, null, 2);
    if(settings.autosaveMode==='handle' && fileHandle){
      try{ const w = await fileHandle.createWritable(); await w.write(new Blob([data], {type:'application/json'})); await w.close(); }
      catch(e){ console.warn('–ó–∞–ø–∏—Å—å –Ω–µ —É–¥–∞–ª–∞—Å—å, –¥–µ–ª–∞—é —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ:', e); fallbackDownload(data); }
    } else if(settings.autosaveMode==='handle' && ('showSaveFilePicker' in window)){
      await chooseAutosaveFile(); if(fileHandle) return autoSaveNow(); else fallbackDownload(data);
    } else {
      fallbackDownload(data);
    }
  }

  function series(rangeDays){
    const today = new Date(); today.setHours(0,0,0,0);
    const labels = []; const xp=[]; const mins=[];
    for(let i=rangeDays-1;i>=0;i--){
      const d = new Date(today); d.setDate(today.getDate()-i);
      const iso = d.toISOString().slice(0,10);
      const e = state.entries[iso] || {};
      labels.push(iso);
      xp.push(e.xp||0);
      mins.push(e.mins||0);
    }
    return {labels, xp, mins};
  }

  function drawChart(canvas, labels, values){
    if(!canvas) return; const ctx = canvas.getContext('2d');
    const W = canvas.width = canvas.clientWidth * (window.devicePixelRatio||1);
    const H = canvas.height = canvas.clientHeight * (window.devicePixelRatio||1);
    ctx.scale((window.devicePixelRatio||1), (window.devicePixelRatio||1));
    const pad = {l:36, r:10, t:10, b:22};
    const w = canvas.clientWidth - pad.l - pad.r;
    const h = canvas.clientHeight - pad.t - pad.b;
    ctx.clearRect(0,0,canvas.clientWidth,canvas.clientHeight);

    ctx.fillStyle = '#0e1621'; ctx.fillRect(0,0,canvas.clientWidth,canvas.clientHeight);

    const maxV = Math.max(10, Math.max.apply(null, values));
    const step = Math.max(1, Math.ceil(maxV / 4));
    ctx.strokeStyle = '#233042'; ctx.lineWidth = 1;
    for(let i=0;i<=4;i++){
      const y = pad.t + h - (i/4)*h; ctx.beginPath(); ctx.moveTo(pad.l, y); ctx.lineTo(pad.l+w, y); ctx.stroke();
      const val = Math.round(i*step);
      ctx.fillStyle = '#9fb2c7'; ctx.font = '12px system-ui'; ctx.textAlign='right'; ctx.textBaseline='middle';
      ctx.fillText((i===4?maxV:val).toString(), pad.l-6, y);
    }

    ctx.strokeStyle = '#5cc8ff'; ctx.lineWidth = 2;
    ctx.beginPath();
    values.forEach((v,i)=>{
      const x = pad.l + (i/(labels.length-1))*w;
      const y = pad.t + h - (v/maxV)*h;
      if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
    });
    ctx.stroke();

    ctx.fillStyle = '#9fb2c7'; ctx.font = '11px system-ui'; ctx.textAlign='center'; ctx.textBaseline='top';
    const n = labels.length; const stepX = Math.max(1, Math.ceil(n/6));
    for(let i=0;i<n;i+=stepX){
      const d = new Date(labels[i]);
      const lab = d.toLocaleDateString('ru-RU', {day:'2-digit', month:'2-digit'});
      const x = pad.l + (i/(n-1))*w; const y = pad.t + h + 4;
      ctx.fillText(lab, x, y);
    }
  }

  function renderCharts(){
    const rangeSel = $('#range-select');
    const range = +(rangeSel && rangeSel.value ? rangeSel.value : 30);
    const s = series(range);
    drawChart($('#chart-xp'), s.labels, s.xp);
    drawChart($('#chart-mins'), s.labels, s.mins);
  }

  // Event wiring (—Ç–µ–ø–µ—Ä—å –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ –ø–æ—Å–ª–µ DOMContentLoaded)
  const rs = document.getElementById('range-select'); if(rs) rs.onchange = renderCharts;

  const be = document.getElementById('btn-export'); if(be) be.onclick = exportJSON;
  const fi = document.getElementById('file-import'); if(fi) fi.onchange = (e)=>{ if(e.target.files && e.target.files[0]) importJSON(e.target.files[0]); e.target.value=''; };
  const br = document.getElementById('btn-reset'); if(br) br.onclick = ()=>{ if(confirm('–°–±—Ä–æ—Å–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ —Ç—Ä–µ–∫–µ—Ä–∞? –≠—Ç–æ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ.')){ state = JSON.parse(JSON.stringify(defaults)); save(); renderAll(); clearForm(); syncToDb(); } };

  const bsd = document.getElementById('btn-save-day'); if(bsd) bsd.onclick = async ()=>{
    const {date, entry} = readForm();
    state.entries[date] = entry; save(); renderAll();
    await syncToDb();
    await autoSaveNow();
    alert('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ: ' + human(date) + (currentUser ? ' (–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–æ)' : ''));
  };
  const bcf = document.getElementById('btn-clear-form'); if(bcf) bcf.onclick = clearForm;

  const bat = document.getElementById('btn-autosave-toggle'); if(bat) bat.onclick = async ()=>{ settings.autosaveEnabled = !settings.autosaveEnabled; saveSettings(); updateAutosaveUI(); if(settings.autosaveEnabled && settings.autosaveMode==='handle'){ await chooseAutosaveFile(); } };
  const bap = document.getElementById('btn-autosave-pick'); if(bap) bap.onclick = chooseAutosaveFile;
  const bs = document.getElementById('btn-sync'); if(bs) bs.onclick = async ()=>{ await syncFromDb(); await syncToDb(); alert('–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∞'); };

  const brg = document.getElementById('btn-register'); if(brg) brg.onclick = authSignup;
  const blg = document.getElementById('btn-login'); if(blg) blg.onclick = authLogin;
  const blo = document.getElementById('btn-logout'); if(blo) blo.onclick = authLogout;

  let deferredPrompt = null;
  window.addEventListener('beforeinstallprompt', (e)=>{ e.preventDefault(); deferredPrompt = e; const b=$('#btn-install-pwa'); if(b) b.style.display='inline-flex'; });
  const bi = document.getElementById('btn-install-pwa'); if(bi) bi.onclick = async ()=>{ if(!deferredPrompt) return; deferredPrompt.prompt(); await deferredPrompt.userChoice; deferredPrompt=null; bi.style.display='none'; };

  if ('serviceWorker' in navigator && location.protocol.startsWith('http')){
    fetch('sw.js', {method:'HEAD'}).then(r=>{ if(r.ok) navigator.serviceWorker.register('sw.js'); }).catch(()=>{});
  }

  // Init (–ø–æ—Å–ª–µ –ø–æ–ª–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ DOM)
  settings = loadSettings();
  updateAutosaveUI();
  supaInit();
  updateAuthUI();
  setDateDefault();
  renderAll();
  const bi2 = document.getElementById('btn-import'); if(bi2) bi2.onclick = ()=> document.getElementById('file-import').click();
})();
});
</script>
</body>
</html>
